---
title: RPC原理和使用
tags:
  - RPC
urlname: RPC原理和使用
categories: 原理
comments: true
img: 'https://blog.xtcgch.ink/img/萌图/pic-01.jpg'
date: 2020-12-02 11:57:10
---

**摘要：**记录常用的RPC框架原理。

<!--more-->

---

# 脑图



---


# <table><tr><td bgcolor=#C7C7C7>前言</td></tr></table>

RPC 框架的目标就是让远程服务调用更加简单、透明

RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。

服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程

![gRPC架构图.png](gRPC架构图.png)


# <table><tr><td bgcolor=#C7C7C7>常见RPC框架</td></tr></table>

业界主流的 RPC 框架整体上分为三类：

- 支持多语言的 RPC 框架，比较成熟的有 Google 的 gRPC、Apache（Facebook）的 Thrift；

- 只支持特定语言的 RPC 框架，例如新浪微博的 Motan；

- 支持服务治理等服务化特性的分布式服务框架，其底层内核仍然是 RPC 框架, 例如阿里的 Dubbo

# <table><tr><td bgcolor=#C7C7C7>gRPC</td></tr></table>


  在 gRPC 里客户端应用可以像调用本地对象一样直接调用另一台不同的机器上服务端应用的方法，使得您能够更容易地创建分布式应用和服务。

  与许多 RPC 系统类似，gRPC 也是基于以下理念：定义一个服务，指定其能够被远程调用的方法（包含参数和返回类型）。

  在服务端实现这个接口，并运行一个 gRPC 服务器来处理客户端调用。

## <font color=#0000FF>gRPC 特点</font>

- 语言中立，支持多种语言

- 基于 IDL ( 接口定义语言（Interface Define Language）)文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub；

- 通信协议基于标准的 HTTP/2 设计，支持·双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量

- 序列化支持 PB（Protocol Buffer）和 JSON，PB 是一种语言无关的高性能序列化框架，基于 HTTP/2 + PB, 保障了 RPC 调用的高性能

## <font color=#0000FF>gRPC 原则</font>

- **服务而非对象、消息而非引用**
  
  促进微服务的系统间粗粒度消息交互设计理念，同时避免分布式对象的陷阱和分布式计算的谬误。

- **普遍并且简单**

  该基础框架应该在任何流行的开发平台上适用，并且易于被个人在自己的平台上构建。它在CPU和内存有限的设备上也应该切实可行。

- **免费并且开源**

  所有人可免费使用基本特性。以友好的许可协议开源方式发布所有交付件。

- **互通性**

  该数据传输协议(Wire Protocol)必须遵循普通互联网基础框架。

- **通用并且高性能**

  该框架应该适用于绝大多数用例场景，相比针对特定用例的框架，该框架只会牺牲一点性能。

- **分层的**

  该框架的关键是必须能够独立演进。对数据传输格式(Wire Format)的修改不应该影响应用层。

- **负载无关的**

  不同的服务需要使用不同的消息类型和编码，例如protocol buffers、JSON、XML和Thrift，协议上和实现上必须满足这样的诉求。类似地，对负载压缩的诉求也因应用场景和负载类型不同而不同，协议上应该支持可插拔的压缩机制。

- **流**

  存储系统依赖于流和流控来传递大数据集。像语音转文本或股票代码等其它服务，依靠流表达时间相关的消息序列。

- **阻塞式和非阻塞式**

  支持异步和同步处理在客户端和服务端间交互的消息序列。这是在某些平台上缩放和处理流的关键。

- **取消和超时**

  有的操作可能会用时很长，客户端运行正常时，可以通过取消操作让服务端回收资源。当任务因果链被追踪时，取消可以级联。客户端可能会被告知调用超时，此时服务就可以根据客户端的需求来调整自己的行为。

- **Lameducking**

  服务端必须支持优雅关闭，优雅关闭时拒绝新请求，但继续处理正在运行中的请求。

- **流控**

  在客户端和服务端之间，计算能力和网络容量往往是不平衡的。流控可以更好的缓冲管理，以及保护系统免受来自异常活跃对端的拒绝服务(DOS)攻击。

- **可插拔的**

  数据传输协议(Wire Protocol)只是功能完备API基础框架的一部分。大型分布式系统需要安全、健康检查、负载均衡和故障恢复、监控、跟踪、日志等。实现上应该提供扩展点，以允许插入这些特性和默认实现。

- **API扩展**

  可能的话，在服务间协作的扩展应该最好使用接口扩展，而不是协议扩展。这种类型的扩展可以包括健康检查、服务内省、负载监测和负载均衡分配。

- **元数据交换**

  常见的横切关注点，如认证或跟踪，依赖数据交换，但这不是服务公共接口中的一部分。部署依赖于他们将这些特性以不同速度演进到服务暴露的个别API的能力。

- **标准化状态码**
  
  客户端通常以有限的方式响应API调用返回的错误。应该限制状态代码名字空间，使得这些错误处理决定更清晰。如果需要更丰富的特定域的状态，可以使用元数据交换机制来提供。

## <font color=#0000FF>gRPC 使用</font>


