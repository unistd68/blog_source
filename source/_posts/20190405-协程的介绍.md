---
title: 协程的介绍
tags:
  - 协程
  - null
urlname: 协程的介绍
categories: 原理
comments: true
img: https://blog.xtcgch.ink/img/萌图/pic-05.jpg
date: 2019-04-05 20:27:04
---

**摘要：**非正式的协程学习笔记！

<!--more-->

---


## <table><tr><td bgcolor=#C7C7C7>简单介绍</td></tr></table>

协程，又称微线程，纤程。英文名Coroutine。

协程属于线程内的概念，脱离了线程就毫无意义。

一个线程可以有很多个协程，协程数受到文件描述符的限制。

协程是原子性的。

协程的切换属于用户态，即只有显示使用协程，cpu才会使用协程的方式来处理代码。

一个线程里的协程共享所有线程内的变量，且是独享，即每个协程获取到的线程变量值都是即时的数据，和线程使用进程内的公共变量不同，也即不需要加锁。

协程的切换是由IO事件来操控，只有当协程发生IO操作，或者协程处理完事件，才会发生协程的切换。

协程占有的资源量比线程小，且通常情况下协程间的切换对资源的消耗是比较小的，主要是因为协程切换时不会发生上下文的切换，cpu会根据偏移量来找到协程对应的栈位置，所以协程间的切换只是偏移量发生了改变，因此对资源的消耗量很小。

和线程比，在IO任务不处理具体事情时，线程会被挂起，但是协程会一直切换，会消耗一定的cpu资源，目前可测出的消耗率约为1%-2%。


---


## <table><tr><td bgcolor=#C7C7C7>语言层面</td></tr></table>

目前支持协程的编程语言主要有python，lua，C/C++


---

## <table><tr><td bgcolor=#C7C7C7>应用场景</td></tr></table>

协程的特性是由IO事件来进行切换，因此在一些IO事件比较频繁的场景下运用，能够产生比较巨大的正面效果，如http/https请求，udp/tcp请求，数据库IO，文件IO，日志IO


---


## <table><tr><td bgcolor=#C7C7C7>一些协程库</td></tr></table>

- libco


---

## <table><tr><td bgcolor=#C7C7C7>坑</td></tr></table>

### <font color=#0000FF >1、锁</font>

在一个函数fun1()中有一个IO操作，如写日志（设定为一直阻塞），并且在写日志前进行加锁，这时可能会发生如下情况：

- 协程A获取锁，进行写日志IO操作
- cpu切换协程B来运行
- 协程B视图获取锁，但是协程A未释放，因此协程B一直等待
- 由于协程A一直阻塞在写日志操作，因此协程B也一直阻塞，也不能被切换出去，造成了死锁

即使协程A未被阻塞，而是耗时比较长，那么协程B也只能等待，这种情况也会比较坑

### <font color=#0000FF >2、socket</font>

---

## <table><tr><td bgcolor=#C7C7C7>一些使用建议</td></tr></table>

1. 在使用IO函数之前要先释放锁
1. 使用最小粒度的锁